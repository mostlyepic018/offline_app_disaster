{% extends 'base.html' %}
{% block content %}
<h2>Mock Phone</h2>
<div style="display:flex; gap:24px; flex-wrap:wrap;">
  <div style="flex:1; min-width:320px;">
    <h3>Send inbound SMS</h3>
    <form method="post" action="/send-inbound" onsubmit="return submitInbound(event)">
      <label>From</label><br/>
      <input name="from" id="from" style="width:100%; padding:8px;" placeholder="+15551234567"/><br/><br/>
      <label>Message</label><br/>
      <textarea name="message" id="message" rows="4" style="width:100%; padding:8px;" placeholder="REPORT: FLOOD at MARKET STREET radius 5km severity HIGH"></textarea><br/>
      <button class="btn" type="submit">Send</button>
      <div id="sendStatus" style="margin-top:8px; color:#2b8a3e;"></div>
    </form>
  </div>
  <div style="flex:1; min-width:320px;">
    <h3>Outbound for this phone</h3>
    <label>Phone</label><br/>
    <input id="phone" style="width:100%; padding:8px;" placeholder="+15551234567"/>
    <div style="margin-top:8px;">
      <button class="btn" onclick="refreshOutbound()">Refresh</button>
      <button class="btn" onclick="markAllSent()">Mark All as Sent</button>
      <span id="outStatus" style="margin-left:8px; color:#555;"></span>
    </div>
    <table style="margin-top:12px;">
      <thead><tr><th>ID</th><th>Body</th></tr></thead>
      <tbody id="outRows"></tbody>
    </table>
  </div>
</div>
<script>
async function submitInbound(e){
  e.preventDefault();
  const frm = document.getElementById('from').value.trim();
  const msg = document.getElementById('message').value.trim();
  const res = await fetch('/send-inbound', {method:'POST', body: new URLSearchParams({from:frm, message:msg})});
  const data = await res.json();
  document.getElementById('sendStatus').textContent = 'Sent: ' + JSON.stringify(data);
  return false;
}
async function refreshOutbound(){
  const phone = document.getElementById('phone').value.trim();
  const rows = document.getElementById('outRows');
  const st = document.getElementById('outStatus');
  rows.innerHTML='';
  const res = await fetch('/get-outbound?phone='+encodeURIComponent(phone));
  const data = await res.json();
  data.forEach(m => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.id}</td><td>${m.body}</td>`;
    rows.appendChild(tr);
  });
  st.textContent = data.length + ' pending';
}
async function markAllSent(){
  const ids = Array.from(document.querySelectorAll('#outRows tr')).map(tr=>parseInt(tr.children[0].textContent,10));
  if(ids.length===0) return;
  await fetch('/mark-sent', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(ids)});
  refreshOutbound();
}
</script>
{% endblock %}
